let watchID;
let previousPosition = null;
let speedReadings = [];
const MAX_READINGS = 5; // Number of readings to average

// Function to calculate speed with smoothing
function calculateSpeed(currentPosition) {
    if (previousPosition) {
        // Calculate distance between previous and current positions
        const distance = getDistance(
            previousPosition.coords.latitude,
            previousPosition.coords.longitude,
            currentPosition.coords.latitude,
            currentPosition.coords.longitude
        );

        // Calculate time difference in seconds
        const timeElapsed = (currentPosition.timestamp - previousPosition.timestamp) / 1000;

        // Calculate speed in m/s
        let speed = distance / timeElapsed;

        // Filter unrealistic jumps (e.g., sudden high speeds)
        if (speed > 10) { // Assume speeds above 10 m/s are unrealistic for walking
            console.log(`Filtered unrealistic speed: ${speed} m/s`);
            return; // Skip this update
        }

        // Add speed to readings array and maintain only recent readings
        speedReadings.push(speed);
        if (speedReadings.length > MAX_READINGS) {
            speedReadings.shift(); // Remove the oldest reading
        }

        // Calculate average speed
        const averageSpeed = speedReadings.reduce((a, b) => a + b, 0) / speedReadings.length;
        document.getElementById('speed').textContent = `Speed: ${averageSpeed.toFixed(2)} m/s`;
    }

    // Update the previous position
    previousPosition = currentPosition;
}

// Function to get distance between two coordinates in meters
function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000; // Radius of the Earth in meters
    const dLat = (lat2 - lat1) * (Math.PI / 180);
    const dLon = (lon2 - lon1) * (Math.PI / 180);
    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c; // Distance in meters
}

// Error handling function
function showError(error) {
    switch (error.code) {
        case error.PERMISSION_DENIED:
            alert("User denied the request for Geolocation.");
            break;
        case error.POSITION_UNAVAILABLE:
            alert("Location information is unavailable.");
            break;
        case error.TIMEOUT:
            alert("The request to get user location timed out.");
            break;
        case error.UNKNOWN_ERROR:
            alert("An unknown error occurred.");
            break;
    }
}

// Start tracking speed
document.getElementById('startBtn').addEventListener('click', () => {
    if (navigator.permissions) {
        navigator.permissions.query({ name: 'geolocation' }).then(function(result) {
            if (result.state === 'granted') {
                startGeolocationTracking();
            } else if (result.state === 'prompt') {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        startGeolocationTracking();
                    },
                    (error) => {
                        showError(error);
                    }
                );
            } else if (result.state === 'denied') {
                alert('Location access is denied. Please allow location access in your browser settings.');
            }
        }).catch((error) => {
            console.error('Error querying geolocation permission:', error);
            alert('Error querying geolocation permission. Please check your browser settings.');
        });
    } else {
        startGeolocationTracking();
    }
});

// Function to start geolocation tracking
function startGeolocationTracking() {
    watchID = navigator.geolocation.watchPosition(calculateSpeed, showError, {
        enableHighAccuracy: true,
        maximumAge: 1000,
        timeout: 5000
    });
    document.getElementById('startBtn').disabled = true;
    document.getElementById('stopBtn').disabled = false;
}

// Stop tracking speed
document.getElementById('stopBtn').addEventListener('click', () => {
    if (watchID) {
        navigator.geolocation.clearWatch(watchID);
        watchID = null;
        previousPosition = null;
        speedReadings = []; // Clear readings
        document.getElementById('speed').textContent = 'Speed: 0 m/s';
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
    }
});

